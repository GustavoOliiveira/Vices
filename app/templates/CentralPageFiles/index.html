<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário com Flatpickr e FullCalendar</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='CentralPage/style.css') }}">
    <link rel="stylesheet" href="/Vices/OptionsPageFiles/optionsPage.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/FavIcon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/FavIcon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/FavIcon/favicon-16x16.png">
    <link rel="manifest" href="/FavIcon/site.webmanifest">
    <link rel="mask-icon" href="/FavIcon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section-container-global">
    <section class="section-bar-left">
        <div class="logo"><p class="font-logo">Vices</p></div>
        <div class="container-options-left-bar">
            <div class="option-left-bar active" data-option="learn" data-target="learn-bar-right">
                <img class="icon-otion-left-bar" src="/assets/calendar-days.png" alt="">
                <p class="font-option-left-bar">Calendario</p>
            </div>
            <div class="option-left-bar" data-option="ranked" data-target="ranked-bar-right">
                <img class="icon-otion-left-bar" src="/assets/e-book.png" alt="">
                <p class="font-option-left-bar">Aprender</p>
            </div>
            <div class="option-left-bar" data-option="calendario" data-target="calendar-bar-right">
                <img class="icon-otion-left-bar" src="/assets/escudo.png" alt="">
                <p class="font-option-left-bar">Ranked</p>
            </div>
            <div class="option-left-bar" data-option="profile" data-target="profile-bar-right">
                <img class="icon-otion-left-bar" src="/assets/habilidades.png" alt="">
                <p class="font-option-left-bar">Perfil</p>
            </div>
            <div class="option-left-bar" data-option="more" data-target="more-bar-right">
                <img class="icon-otion-left-bar" src="/assets/search-engine-optimization.png" alt="">
                <p class="font-option-left-bar">Mais</p>
            </div>
            
        </div>
    </section>

    <section class="section-center">    
        <div id="learn" class="content-section-center">
            <div class="content-mod-section-learn">
                <div id="calendar"></div>
                <div id="modal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h3>Editar intervalo de datas</h3>
                        <label for="eventTitle">Título do Evento:</label>
                        <input type="text" id="editDatePicker" placeholder="Escolha um intervalo de datas" />
                        <button id="updateButton">Atualizar</button>
                        <button id="deleteButton">Excluir</button> <!-- Botão de exclusão -->
                    </div>
                </div>
            </div> 
        </div>  
        <div id="ranked" class="content-section-center">
            <div class="content-mod-section-ranked">
                        <!-- Div de boas-vindas, inicialmente escondida -->
                <div id="welcome-overlay" class="welcome-overlay">
                    <div class="welcome-message">
                        <div class="avatar-question">
                            <button id="exitButton">X</button>
                            <div class="container-gif-question">
                                <div class="container-gif">
                                    <video id="myVideo" class="gif-question" autoplay loop muted playsinline>
                                        <source  src="/assets/CentralPage/psico-light.MP4" type="video/mp4">
                                        Seu navegador não suporta a tag de vídeo.
                                    </video>
                                </div>
                                <div class="chat-question">
                                    <div class="chat"><p>conte um pouco sobre você <br>estou anotando tudo!</p></div>
                                </div> 
                            </div>
                        </div>
                        <div class="welcome">
                            <div id="quiz-container">
                                <div class="question-container" style="display:blocks;">
                                    <p>Qual é a capital da França?</p>
                                    <div class="options">
                                        <button class="option">Paris</button>
                                        <button class="option">Londres</button>
                                        <button class="option">Berlim</button>
                                        <button class="option">Madrid</button>
                                    </div>
                                </div>
                            
                                <div class="question-container" style="display: none;">
                                    <p>Qual é a maior montanha do mundo?</p>
                                    <div class="options">
                                        <button class="option">K2</button>
                                        <button class="option">Kilimanjaro</button>
                                        <button class="option">Everest</button>
                                        <button class="option">Aconcágua</button>
                                    </div>
                                </div>
                            
                                <div class="question-container" style="display: none;">
                                    <p>Qual é o maior oceano do mundo?</p>
                                    <div class="options">
                                        <button class="option">Atlântico</button>
                                        <button class="option">Índico</button>
                                        <button class="option">Ártico</button>
                                        <button class="option">Pacífico</button>
                                    </div>
                                </div>
                            
                          
                            </div>
                            
                            
                        </div>
                        <div class="container-button-next">
                            <button id="nextButton">Próxima</button>
                            <button id="finishButton" style="display: none;">Finalizar</button>
                        </div>
                    </div>
                </div>

                <div class="section-learn">
                    <div class="div-left-section-learn">
                        <div class="number-of-section-01"><p>Seção 3</p></div>
                        <div class="bar-progress">
                            <div class="body-bar-progress">
                                <p class="result-bar-progress">0/10</p>
                            </div>
                        </div>
                        <div class="continue-or-learn-content">
                            <div class="continue-or-learn">
                                <p class="font-continue-or-learn">ESTUDAR</p>
                            </div>
                        </div>
                    </div>
                    <div class="div-right-section-learn">
                        <div class="box-chat-avatar-content">
                            <div class="box-chat-avatar"></div>
                        </div>
                        <div class="avatar-content">
                            <img class="img-avatar" src="/assets/inicialPage/avatar.mp4/avatar-01.png" alt="">
                        </div>
                    </div>
                </div>
                <div class="section-learn">
                    <div class="div-left-section-learn">
                        <div class="number-of-section-01"><p>Seção 1</p></div>
                        <div class="bar-progress">
                            <div class="body-bar-progress">
                                <p class="result-bar-progress">0/10</p>
                            </div>
                        </div>
                        <div class="continue-or-learn-content">
                            <div class="continue-or-learn">
                                <p class="font-continue-or-learn">ESTUDAR</p>
                            </div>
                        </div>
                    </div>
                    <div class="div-right-section-learn">
                        <div class="box-chat-avatar-content">
                            <div class="box-chat-avatar"></div>
                        </div>
                        <div class="avatar-content">
                            <img class="img-avatar" src="/assets/inicialPage/avatar.mp4/avatar-02.png" alt="">
                        </div>
                    </div>
                </div>
                <div class="section-learn">
                    <div class="div-left-section-learn">
                        <div class="number-of-section-01"><p>Seção 1</p></div>
                        <div class="bar-progress">
                            <div class="body-bar-progress">
                                <p class="result-bar-progress">0/10</p>
                            </div>
                        </div>
                        <div class="continue-or-learn-content">
                            <div class="continue-or-learn">
                                <p class="font-continue-or-learn">ESTUDAR</p>
                            </div>
                        </div>
                    </div>
                    <div class="div-right-section-learn">
                        <div class="box-chat-avatar-content">
                            <div class="box-chat-avatar"></div>
                        </div>
                        <div class="avatar-content">
                            <img class="img-avatar" src="/assets/inicialPage/avatar.mp4/avatar-03.png" alt="">
                        </div>
                    </div>
                </div>
                <div class="section-learn">
                    <div class="div-left-section-learn">
                        <div class="number-of-section-01"><p>Seção 4</p></div>
                        <div class="bar-progress">
                            <div class="body-bar-progress">
                                <p class="result-bar-progress">0/10</p>
                            </div>
                        </div>
                        <div class="continue-or-learn-content">
                            <div class="continue-or-learn">
                                <p class="font-continue-or-learn">ESTUDAR</p>
                            </div>
                        </div>
                    </div>
                    <div class="div-right-section-learn">
                        <div class="box-chat-avatar-content">
                            <div class="box-chat-avatar"></div>
                        </div>
                        <div class="avatar-content">
                            <img class="img-avatar" src="/assets/inicialPage/avatar.mp4/avatar-04.png" alt="">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="Calendar" class="content-section-center"></div>
        <div id="profile" class="content-section-center">
            <div class="container-conteudo-prifile">
                <div id="app">
                    <div id="chat-login">
                        <h2>Login</h2>
                        <input type="email" id="chat-email" placeholder="Email">
                        <input type="password" id="chat-password" placeholder="Password">
                        <button id="chat-login-button">Login</button>
                        <button id="chat-google-login-button">Login with Google</button>
                    </div>
                
                    <div id="chat" style="display: none;">
                        <div id="user-profile" class="profile"></div>
                
                        <div id="sidebar">
                            <div class="container-chats-groups">
                                <div class="create-private-and-group-chat">
                                    <h3>Chats</h3>
                                    <div class="chat-options">
                                        <button id="private-chat-button">P</button>
                                        <button id="create-group-button">G</button>
                                    </div>
                                </div>
                                <div id="privateChatsList"></div>
                                <div id="groupChatsList"></div>
                            </div>
                            <div class="container-config-chat">  
                                <div id="chat-logout" style="display: none;">
                                    <button id="chat-logout-button">Logout</button>
                                </div>
                            </div>
                        </div>
                
                        <div id="message-container">
                            <ul id="messages"></ul>
                            <div class="container-sendMessage">
                                <input type="text" id="messageInput" placeholder="Type your message here...">
                                <button id="sendMessage">S</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="more" class="content-section-center">
            <div class="content-mod-more">
                <div class="content-config">
                    <div class="preferencias">
                        <div class="text-preferencias">
                            <p class="font-preferencias">Preferencias</p>
                        </div>
                        <div class="experiencia">
                            <p class="font-experiencia">experiencia</p>
                        </div>
                    </div>
                    <div class="chaves-seletoras">
                        <div class="efeitos-sonoros">
                            <div class="text-efeito-sonoros">
                                <p class="font-chaves-seletoras">Efeito sonoros</p>
                            </div>
                            <div class="container-chave-seletora"></div>
                        </div>
                        <div class="inimacoes">
                            <div class="text-animacoes">
                                <p class="font-chaves-seletoras">Animações</p>
                            </div>
                            <div class="container-chave-seletora"></div>
                        </div>
                        <div class="mensagens-motivacionais">
                            <div class="text-mensagens-motivacionas">
                                <p class="font-chaves-seletoras">Frases motivacionais</p>
                            </div>
                            <div class="container-chave-seletora"></div>
                        </div>
                        <div class="text-visual">
                            <p class="font-experiencia">Visual</p>
                        </div>
                    </div>
                    <div class="escuro-ou-claro">
                        <div class="text-modo-escuro">
                            <p class="font-modo-escuro">Modo escuro</p>
                        </div>
                        <div class="dropdown">
                            <button class="dropdown-btn">Selecione uma opção</button>
                            <div class="dropdown-content">
                                <a href="#" data-theme="light">Claro</a>
                                <a href="#" data-theme="dark">Escuro</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> 
    </section>


    <section class="sectio-bar-right">
        <div id="learn-bar-right" class="content-section-bar-right">
            <div class="bar-score">
                <div class="container-max-score">
                    <img class="img-fire-score" src="/assets/fogo.png" alt="">
                    <p id="maxScore">0</p>
                </div>
                <div class="container-last-interval">
                    <img class="img-fire-score" src="/assets/coin.png" alt="">
                    <p id="lastInterval">0</p> <!-- Nova sessão para exibir o último intervalo -->
                </div>
                <div class="container-profile-bar-score">
                    <img class="img-fire-score" src="/assets/profile.png" alt="">
                </div>
            </div>
            <div class="container-ranked-loginRegister">
                <div class="ranked-information">
                    <div class="firt-row-ranked-information">
                        <p class="font-first-row">Desbloqueie ligas</p>
                    </div>
                    <div class="second-row-ranked-information">
                        <img class="img-ranked-information" src="/assets/fechadura.png" alt="">
                        <p class="font-second-row" >Complete mais dez lições para <br> começar a competir.</p>
                    </div>    
                </div>
                <div class="login-register">
                    <div class="first-row-login-register">
                        <p class="font-first-row">Crie um perfil para salvar seu progresso!</p>
                    </div>
                    <div class="second-row-login-register">
                        <div class="create-profile">
                            <div class="font-create-profile">
                                <p >criar um perfil</p>
                            </div>
                            <div class="div-blind"></div>
                        </div>
                        <div class="login">
                            <div id="login" class="font-create-profile">
                                <p>entrar</p>
                            </div>
                            <div id="blind-login" class="div-blind"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="ranked-bar-right" class="content-section-bar-right">
            <div class="bar-score">
                <div class="container-max-score">
                    <img class="img-fire-score" src="/assets/fogo.png" alt="">
                    <p id="maxScore">0</p>
                </div>
                <div class="container-last-interval">
                    <img class="img-fire-score" src="/assets/coin.png" alt="">
                    <p id="lastInterval">0</p> <!-- Nova sessão para exibir o último intervalo -->
                </div>
                <div class="container-profile-bar-score">
                    <img class="img-fire-score" src="/assets/profile.png" alt="">
                </div>
            </div>
            <div class="container-ranked-loginRegister">
                <div class="ranked-information">
                    <div class="firt-row-ranked-information">
                        <p class="font-first-row">Desbloqueie ligas</p>
                    </div>
                    <div class="second-row-ranked-information">
                        <img class="img-ranked-information" src="/assets/fechadura.png" alt="">
                        <p class="font-second-row" >Complete mais dez lições para <br> começar a competir.</p>
                    </div>    
                </div>
                <div class="login-register">
                    <div class="first-row-login-register">
                        <p class="font-first-row">Crie um perfil para salvar seu progresso!</p>
                    </div>
                    <div class="second-row-login-register">
                        <div class="create-profile">
                            <div class="font-create-profile">
                                <p >criar um perfil</p>
                            </div>
                            <div class="div-blind"></div>
                        </div>
                        <div class="login">
                            <div id="login" class="font-create-profile">
                                <p>entrar</p>
                            </div>
                            <div id="blind-login" class="div-blind"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="calendar-bar-right" class="content-section-bar-right"></div>
        <div id="profile-bar-right" class="content-section-bar-right">
            <button id="clearButton">Limpar Todas as Datas</button>
            <p id="savedDates"></p>
            <p>skdwkwkcnwkcwjkc</p>
        </div>
        <div id="more-bar-right" class="content-section-bar-right"></div>
    </section>
</section>

    




<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc , collection, addDoc, onSnapshot, query, orderBy, getDocs, where} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, signInWithPopup, GoogleAuthProvider} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyA8jaKmNivdVd-0J_lDpTJJ8tXL7vUOCPk",
        authDomain: "vices-application.firebaseapp.com",
        projectId: "vices-application",
        storageBucket: "vices-application.appspot.com",
        messagingSenderId: "223731456449",
        appId: "1:223731456449:web:770ac9d0a32affe283f740"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);


let savedDates = []; // Array para armazenar os intervalos de datas salvas
let savedEvents = []; // Array para armazenar os eventos salvos
let calendar; // Variável para armazenar a instância do calendário
let currentEvent = null; // Variável para armazenar o evento que está sendo editado
let initialDate = null; // Armazena a data inicial
let isLoadingSavedEvents = false; // Variável para controlar o carregamento de eventos salvos
const userId = "yourUserId"; // Substitua pelo ID do usuário

// Função para inicializar o FullCalendar
function initCalendar() {
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: ''
        },
        events: savedEvents, // Carrega eventos salvos do Firestore
        eventClick: function(info) {
            currentEvent = info.event; // Armazena o evento atual
            openEditModal(info.event); // Abre o modal para edição
        },
        dateClick: function(info) {
            if (!isLoadingSavedEvents) { // Verifica se não está carregando eventos
                initialDate = info.date; // Define a data inicial
                addInitialEvent(info.date); // Adiciona uma nova data inicial ao clicar
            }
        }
    });
    calendar.render();
}

// Função para carregar as datas salvas e eventos do Firestore ao carregar a página
async function loadSavedData() {
    const userDoc = doc(db, "users", userId);
    const docSnap = await getDoc(userDoc);

    if (docSnap.exists()) {
        const data = docSnap.data();
        console.log("Dados carregados do Firestore:", data);

        savedDates = data.savedDates || [];
        savedEvents = data.savedEvents || [];

        // Limpa os eventos atuais do calendário (se necessário)
        calendar.removeAllEvents(); // Opcional, dependendo da sua lógica

        // Adiciona eventos ao calendário
        savedEvents.forEach(eventData => {
            const event = {
                title: eventData.title,
                start: eventData.start.toDate(), // Converter Timestamp para Date
                end: eventData.end.toDate(),     // Converter Timestamp para Date
                allDay: eventData.allDay
            };
            calendar.addEvent(event); // Adiciona o evento ao calendário visualmente
        });

        updateSavedDatesText();
        findMaxScore();
        updateLastInterval();
    } else {
        document.getElementById("savedDates").textContent = 'Nenhuma data salva.';
    }
}



// Função para salvar os dados no Firestore
async function saveDataToFirestore() {
    const userDoc = doc(db, "users", userId);
    const dataToSave = {
        savedDates: savedDates,
        savedEvents: savedEvents // Certifique-se de que essa variável está corretamente preenchida
    };

    console.log("Salvando dados no Firestore:", dataToSave);

    try {
        await setDoc(userDoc, dataToSave, { merge: true });
        console.log("Dados salvos no Firestore com sucesso!");
    } catch (e) {
        console.error("Erro ao salvar no Firestore: ", e);
    }
}



// Função para adicionar um evento ao calendário
function addEventToCalendar(startDate, endDate, save = true) {
    const event = {
        title: `Datas: ${startDate.toLocaleDateString()} a ${endDate.toLocaleDateString()}`,
        start: startDate,
        end: new Date(endDate.getTime() + 24 * 60 * 60 * 1000), // Corrige o dia a mais
        allDay: true
    };
    calendar.addEvent(event);

    const differenceInDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1; // Calcula a diferença de dias

    if (save) {
        savedDates.push(`${differenceInDays}`);
        savedEvents.push(event);
        saveDataToFirestore(); // Salva os dados no Firestore
    }

    updateSavedDatesText(); // Atualiza a exibição das datas salvas
    findMaxScore(); // Atualiza a pontuação máxima
    updateLastInterval(); // Atualiza o último intervalo salvo
}

// Atualiza o texto das datas salvas
function updateSavedDatesText() {
    document.getElementById("savedDates").textContent = savedDates.length > 0 
        ? `Intervalos salvos: ${savedDates.join(', ')}`
        : 'Nenhuma data salva.';
}

// Função para encontrar a pontuação máxima
function findMaxScore() {
    let maxDays = 0;
    let maxDateRange = '';

    savedDates.forEach(dateRange => {
        const days = parseInt(dateRange.split(' ')[0]);
        if (days > maxDays) {
            maxDays = days;
            maxDateRange = dateRange;
        }
    });

    document.getElementById("maxScore").textContent = maxDays > 0 
        ? ` ${maxDateRange}` 
        : '';
}

// Função para atualizar o último intervalo salvo
function updateLastInterval() {
    document.getElementById("lastInterval").textContent = savedDates.length > 0 
        ? ` ${savedDates[savedDates.length - 1]}`
        : '';
}

// Abre o modal para editar o intervalo de datas
function openEditModal(event) {
    const startDate = new Date(event.start);
    const endDate = new Date(event.end);
    document.getElementById("editDatePicker").flatpickr({
        mode: "range",
        defaultDate: [startDate, endDate], // Preenche o seletor com as datas atuais
        onClose: function(selectedDates) {
            if (selectedDates.length === 2) {
                const newStartDate = selectedDates[0];
                const newEndDate = selectedDates[1];
                event.remove(); // Remove o evento anterior
                addEventToCalendar(newStartDate, newEndDate); // Adiciona o evento atualizado
                document.getElementById("modal").style.display = "none"; // Fecha o modal
            }
        }
    });
    document.getElementById("modal").style.display = "flex"; // Exibe o modal
}

// Função para excluir o evento atual
async function deleteCurrentEvent() {
    if (currentEvent) {
        currentEvent.remove();

        savedEvents = savedEvents.filter(event => {
            return !(event.start === currentEvent.start.toISOString() && 
                     event.end === currentEvent.end.toISOString() && 
                     event.title === currentEvent.title);
        });

        const days = parseInt(currentEvent.title.split(' ')[1]);
        savedDates = savedDates.filter(dateRange => !dateRange.includes(days + ''));

        await updateDoc(doc(db, "users", userId), {
            savedDates: savedDates,
            savedEvents: savedEvents
        });

        updateSavedDatesText();
        findMaxScore();
        updateLastInterval();

        document.getElementById("modal").style.display = "none";
    }
}

// Limpa todas as datas e eventos salvos
async function clearAllData() {
    savedDates = [];
    savedEvents = [];
    calendar.removeAllEvents();

    await deleteDoc(doc(db, "users", userId)); // Remove os dados do Firestore

    updateSavedDatesText();
    findMaxScore();
    updateLastInterval();
}

// Fecha o modal ao clicar no "X"
function closeModal() {
    document.getElementById("modal").style.display = "none"; // Fecha o modal
}

// Adiciona um novo evento de data inicial ao clicar no calendário
function addInitialEvent(date) {
    if (initialDate) {
        const event = {
            title: `Data inicial: ${initialDate.toLocaleDateString()}`,
            start: initialDate,
            end: new Date(initialDate.getTime() + 24 * 60 * 60 * 1000), // Marca apenas a data inicial
            allDay: true
        };
        calendar.addEvent(event);
        savedEvents.push(event);
        saveDataToFirestore(); // Salva os dados no Firestore
        initialDate = null; // Reseta a data inicial
    } else {
        initialDate = date; // Armazena a data inicial
    }
}

// Inicializa o calendário e carrega os dados salvos
document.addEventListener('DOMContentLoaded', function() {
    initCalendar(); // Inicializa o calendário
    loadSavedData(); // Carrega os dados salvos

    const clearButton = document.getElementById('clearButton');
    if (clearButton) {
        clearButton.addEventListener('click', clearAllData);
    }

    const closeButton = document.querySelector('.close');
    if (closeButton) {
        closeButton.addEventListener('click', closeModal);
    }

    const deleteButton = document.getElementById('deleteButton');
    if (deleteButton) {
        deleteButton.addEventListener('click', deleteCurrentEvent);
    }
});

// code by chat----------------------------------------------------------------------------

// Declara o provider globalmente para que possa ser acessado em toda a aplicação
const provider = new GoogleAuthProvider();

// Obtenção de elementos do DOM
const chatEmailInput = document.getElementById('chat-email');
const chatPasswordInput = document.getElementById('chat-password');
const chatLoginButton = document.getElementById('chat-login-button');
const chatGoogleLoginButton = document.getElementById('chat-google-login-button');
const chatLogoutButton = document.getElementById('chat-logout-button');
const chatDiv = document.getElementById('chat');
const chatLoginDiv = document.getElementById('chat-login');
const chatLogoutDiv = document.getElementById('chat-logout');
const messageInput = document.getElementById('messageInput');
const messagesList = document.getElementById('messages');
const sendMessageButton = document.getElementById('sendMessage');
const userProfileDiv = document.getElementById('user-profile');
const privateChatButton = document.getElementById('private-chat-button');
const createGroupButton = document.getElementById('create-group-button');
const privateChatsList = document.getElementById('privateChatsList');
const groupChatsList = document.getElementById('groupChatsList');
const sidebar = document.getElementById('sidebar');
const messageContainer = document.getElementById('message-container');

// Dados do usuário
let currentUserProfile = {
    displayName: null,
    profilePicture: null,
    backgroundColor: '#fff'
};

// Contexto do chat atual
let currentChat = {
    type: 'global', // 'global', 'private', 'group'
    id: 'global'    // 'global', ou ID do chat
};

// Adiciona os eventos após o carregamento do DOM
document.addEventListener('DOMContentLoaded', function () {
    if (chatLoginButton) chatLoginButton.addEventListener('click', chatLogin);
    if (chatGoogleLoginButton) chatGoogleLoginButton.addEventListener('click', chatLoginWithGoogle);
    if (chatLogoutButton) chatLogoutButton.addEventListener('click', chatLogout);
    if (sendMessageButton) sendMessageButton.addEventListener('click', sendMessage);
    if (privateChatButton) privateChatButton.addEventListener('click', startPrivateChat);
    if (createGroupButton) createGroupButton.addEventListener('click', createGroup);
});

// Exibe a interface do chat
function showChatUI() {
    chatLoginDiv.style.display = 'none';
    chatDiv.style.display = 'flex'; // Alterado para flex para sidebar e área de mensagens
    chatLogoutDiv.style.display = 'block';
    loadUserProfile(); // Carrega o perfil do usuário
    loadChats(); // Carrega todos os chats, incluindo o global
}

// Oculta a interface do chat
function hideChatUI() {
    chatLoginDiv.style.display = 'block';
    chatDiv.style.display = 'none';
    chatLogoutDiv.style.display = 'none';
}

// Carrega o perfil do usuário
function loadUserProfile() {
    const user = auth.currentUser;
    if (user) {
        currentUserProfile.displayName = user.displayName || user.email;
        currentUserProfile.profilePicture = user.photoURL || 'default-profile.png';
        userProfileDiv.innerHTML = `
            <img src="${currentUserProfile.profilePicture}" alt="Profile Picture" class="profile-pic">
            <button id="edit-profile-button">Edit</button>
        `;
        document.getElementById('edit-profile-button').addEventListener('click', editUserProfile);
    } else {
        console.error("No user is currently signed in.");
    }
}

// Edita o perfil do usuário (nome, foto de perfil)
function editUserProfile() {
    const newDisplayName = prompt("Enter your new display name", currentUserProfile.displayName);
    const newProfilePicture = prompt("Enter the URL of your new profile picture", currentUserProfile.profilePicture);
    const newBackgroundColor = prompt("Choose a background color for your chat", currentUserProfile.backgroundColor);

    if (newDisplayName) currentUserProfile.displayName = newDisplayName;
    if (newProfilePicture) currentUserProfile.profilePicture = newProfilePicture;
    if (newBackgroundColor) currentUserProfile.backgroundColor = newBackgroundColor;

    chatDiv.style.backgroundColor = newBackgroundColor;

    // Atualiza o perfil do usuário no Firebase
    const user = auth.currentUser;
    if (user) {
        updateUserProfile(user, {
            displayName: currentUserProfile.displayName,
            photoURL: currentUserProfile.profilePicture
        }).then(() => {
            console.log("Profile updated!");
            loadUserProfile(); // Recarrega os dados do perfil
        }).catch(error => {
            console.error("Error updating profile: ", error);
        });
    } else {
        console.error("No user is currently signed in.");
    }
}

// Função para atualizar o perfil do usuário no Firebase
function updateUserProfile(user, newProfileData) {
    return updateProfile(user, {
        displayName: newProfileData.displayName,
        photoURL: newProfileData.photoURL
    });
}

// Login com email e senha
async function chatLogin() {
    const email = chatEmailInput.value;
    const password = chatPasswordInput.value;

    if (!email || !password) {
        console.error("Email or password is missing.");
        return;
    }

    try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Cria ou atualiza o documento do usuário no Firestore
        await createUserInFirestore(user);

        console.log("Chat user logged in");
        showChatUI();
    } catch (error) {
        console.error("Chat login error: ", error);
    }
}

// Fetch or create the global chat room once
async function fetchOrCreateGlobalChat() {
    const globalChatRef = doc(db, 'chats', 'global-chat');

    const globalChatDoc = await getDoc(globalChatRef);

    if (!globalChatDoc.exists()) {
        // If the global chat does not exist, create it
        await setDoc(globalChatRef, {
            name: 'Global Chat',
            createdAt: new Date(),
            messages: [] // Optionally, initialize with an empty messages array
        });
        console.log("Global chat room created.");
    } else {
        console.log("Global chat room exists.");
    }

    // Now, listen for messages in the global chat
    listenForGlobalMessages(globalChatRef);
}

// Fetch or create the global chat when user logs in
auth.onAuthStateChanged(async (user) => {
    if (user) {
        console.log("Chat user logged in: ", user);
        showChatUI();

        // Fetch or create the global chat
        await fetchOrCreateGlobalChat();

        // Fetch private and group chats
        fetchPrivateChats();
        fetchGroupChats();
    } else {
        console.log("No chat user logged in");
        hideChatUI();
    }
});

// Listen for messages in the global chat
function listenForGlobalMessages(globalChatRef) {
    const q = query(collection(globalChatRef, 'messages'), orderBy('timestamp'));
    onSnapshot(q, (snapshot) => {
        messagesList.innerHTML = ''; // Clear the message list
        snapshot.forEach((doc) => {
            const messageData = doc.data();
            const li = document.createElement('li');
            li.textContent = `${messageData.senderName}: ${messageData.text}`;
            messagesList.appendChild(li);
        });
        scrollToBottom();
    });
}


// Cria ou atualiza o usuário no Firestore
async function createUserInFirestore(user) {
    const userRef = doc(db, 'users', user.uid); // Referência ao documento do usuário

    // Verifica se o documento já existe
    const userDoc = await getDoc(userRef);
    if (!userDoc.exists()) {
        // Se o documento não existir, cria um novo
        await setDoc(userRef, {
            email: user.email,
            displayName: user.displayName || user.email,
            // Adicione outros campos necessários
        });
        console.log("User document created in Firestore:", user.uid);
    } else {
        console.log("User document already exists:", user.uid);
    }
}

// Login com Google
async function chatLoginWithGoogle() {
    try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        // Cria ou atualiza o documento do usuário no Firestore
        await createUserInFirestore(user);

        console.log("Chat user logged in with Google");
        showChatUI();
    } catch (error) {
        console.error("Chat Google login error: ", error);
    }
}

// Logout do chat
async function chatLogout() {
    try {
        await signOut(auth);
        console.log("Chat user logged out");
        hideChatUI();
    } catch (error) {
        console.error("Chat logout error: ", error);
    }
}



// Carrega todos os chats (global, privados, grupos)
async function loadChats() {
    loadGlobalChat();
    fetchPrivateChats();
    fetchGroupChats();
}

// Carrega o chat global
function loadGlobalChat() {
    // Cria um item de chat global na sidebar
    const chatElement = document.createElement('div');
    chatElement.classList.add('chat-item');
    chatElement.textContent = 'Global Chat';
    chatElement.dataset.type = 'global';
    chatElement.dataset.id = 'global';
    chatElement.addEventListener('click', () => {
        setCurrentChat({ type: 'global', id: 'global' });
    });
    // Adiciona no topo da sidebar
    sidebar.insertBefore(chatElement, sidebar.firstChild);
    // Define o chat global como chat padrão
    setCurrentChat({ type: 'global', id: 'global' });
}

// Listener para novas mensagens baseado no chat atual
let unsubscribeMessages = null;

// Listener para novas mensagens baseado no chat atual
function listenForMessages() {
    if (unsubscribeMessages) {
        unsubscribeMessages();
    }

    let messagesQuery;
    if (currentChat.type === 'global') {
        messagesQuery = query(collection(db, 'messages'), orderBy('timestamp'));
    } else if (currentChat.type === 'private') {
        messagesQuery = query(collection(db, 'privateChats', currentChat.id, 'messages'), orderBy('timestamp'));
    } else if (currentChat.type === 'group') {
        messagesQuery = query(collection(db, 'groups', currentChat.id, 'messages'), orderBy('timestamp'));
    }

    unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
        messagesList.innerHTML = ''; // Limpa a lista antes de adicionar mensagens
        snapshot.forEach(doc => {
            const messageData = doc.data();
            const li = document.createElement('li');

            // Se a mensagem for do usuário logado, aplica a classe 'user-message', senão 'other-message'
            const messageClass = (messageData.senderId === auth.currentUser.uid) ? 'user-message' : 'other-message';
            li.classList.add(messageClass);

            // Adiciona o nome do remetente em uma tag <span> pequena
            li.innerHTML = `
                <span class="sender-name">${messageData.senderName}</span><br>
                ${messageData.text}
            `;

            messagesList.appendChild(li);
        });
        scrollToBottom(); // Rola para baixo após atualizar as mensagens
    });
}


// Define o chat atual e carrega as mensagens
function setCurrentChat(chat) {
    currentChat = chat;
    highlightActiveChat();
    listenForMessages();
    clearMessages();
}

// Destaca o chat ativo na sidebar
function highlightActiveChat() {
    const chatItems = document.querySelectorAll('.chat-item');
    chatItems.forEach(item => {
        if (item.dataset.type === currentChat.type && item.dataset.id === currentChat.id) {
            item.classList.add('active-chat');
        } else {
            item.classList.remove('active-chat');
        }
    });
}

// Limpa a lista de mensagens
function clearMessages() {
    messagesList.innerHTML = '';
}

// Envia mensagem para o Firestore baseado no chat atual
async function sendMessage() {
    const message = messageInput.value;
    const user = auth.currentUser;

    if (message.trim() && user) {
        try {
            if (currentChat.type === 'global') {
                await addDoc(collection(db, 'messages'), {
                    text: message,
                    senderId: user.uid,
                    senderName: user.displayName || user.email,
                    timestamp: new Date()
                });
            } else if (currentChat.type === 'private') {
                await addDoc(collection(db, 'privateChats', currentChat.id, 'messages'), {
                    text: message,
                    senderId: user.uid,
                    senderName: user.displayName || user.email,
                    timestamp: new Date()
                });
            } else if (currentChat.type === 'group') {
                await addDoc(collection(db, 'groups', currentChat.id, 'messages'), {
                    text: message,
                    senderId: user.uid,
                    senderName: user.displayName || user.email,
                    timestamp: new Date()
                });
            }
            messageInput.value = ''; // Limpa o campo de entrada
        } catch (error) {
            console.error("Error sending message: ", error);
        }
    } else {
        console.error("Message is empty or user is not authenticated.");
    }
}

// Inicia um chat privado
async function startPrivateChat() {
    const recipientEmail = prompt("Enter the email of the user to chat privately with:");
    if (!recipientEmail) return;

    const q = query(collection(db, 'users'), where('email', '==', recipientEmail));
    const userSnapshot = await getDocs(q);

    if (userSnapshot.empty) {
        alert("User not found.");
        return;
    }

    const recipient = userSnapshot.docs[0].data();
    const recipientId = userSnapshot.docs[0].id; // Certifique-se de que você está pegando o ID corretamente

    if (!recipientId) {
        console.error("Recipient ID is undefined");
        return;
    }

    // Determina o chatId ordenando os IDs para garantir a unicidade
    const currentUserId = auth.currentUser.uid;
    const sortedIds = [currentUserId, recipientId].sort();
    const privateChatId = `${sortedIds[0]}_${sortedIds[1]}`;

    const privateChatRef = doc(db, 'privateChats', privateChatId);

    const privateChatDoc = await getDoc(privateChatRef);
    if (!privateChatDoc.exists()) {
        // Cria uma nova sala de chat privada
        await setDoc(privateChatRef, {
            userIds: sortedIds,
            createdAt: new Date()
        });
        console.log(`Private chat created with ${recipientEmail}`);
    } else {
        console.log(`Private chat already exists with ${recipientEmail}`);
    }

    // Adiciona o chat privado à sidebar se ainda não existir
    addPrivateChatToSidebar(privateChatId, recipient.displayName || recipient.email);
    // Define o chat atual para o chat privado
    setCurrentChat({ type: 'private', id: privateChatId });
}

// Busca chats privados do usuário
async function fetchPrivateChats() {
    const userId = auth.currentUser.uid;
    const privateChatsRef = collection(db, 'privateChats');
    const qPrivate = query(privateChatsRef, where('userIds', 'array-contains', userId));

    try {
        const snapshot = await getDocs(qPrivate);
        privateChatsList.innerHTML = '';  // Limpa a lista antes de adicionar os novos chats

        if (snapshot.empty) {
            privateChatsList.innerHTML = '<p>No private chats found.</p>';
            return;
        }

        snapshot.forEach(doc => {
            const chat = doc.data();
            const chatId = doc.id;
            const otherUserId = chat.userIds.find(id => id !== userId);
            // Busca o nome do outro usuário
            getUserDisplayName(otherUserId).then(displayName => {
                addPrivateChatToSidebar(chatId, displayName);
            });
        });
    } catch (error) {
        console.error("Error fetching private chats: ", error);
    }
}

// Adiciona um chat privado à sidebar
function addPrivateChatToSidebar(chatId, displayName) {
    // Verifica se o chat já existe na sidebar
    const existingChat = document.querySelector(`.chat-item[data-type="private"][data-id="${chatId}"]`);
    if (existingChat) return;

    const chatElement = document.createElement('div');
    chatElement.classList.add('chat-item');
    chatElement.textContent = `Private: ${displayName}`;
    chatElement.dataset.type = 'private';
    chatElement.dataset.id = chatId;
    chatElement.addEventListener('click', () => {
        setCurrentChat({ type: 'private', id: chatId });
    });
    privateChatsList.appendChild(chatElement);
}

// Busca chats em grupo do usuário
async function fetchGroupChats() {
    const userId = auth.currentUser.uid;
    const groupChatsRef = collection(db, 'groups');
    const qGroup = query(groupChatsRef, where('userIds', 'array-contains', userId));

    try {
        const snapshot = await getDocs(qGroup);
        groupChatsList.innerHTML = '';  // Limpa a lista antes de adicionar os novos grupos

        if (snapshot.empty) {
            groupChatsList.innerHTML = '<p>No group chats found.</p>';
            return;
        }

        snapshot.forEach(doc => {
            const group = doc.data();
            const groupId = doc.id;
            const groupName = group.name || `Group ${groupId}`;
            addGroupChatToSidebar(groupId, groupName);
        });
    } catch (error) {
        console.error("Error fetching group chats: ", error);
    }
}

// Adiciona um chat em grupo à sidebar
function addGroupChatToSidebar(groupId, groupName) {
    // Verifica se o grupo já existe na sidebar
    const existingGroup = document.querySelector(`.chat-item[data-type="group"][data-id="${groupId}"]`);
    if (existingGroup) return;

    const groupElement = document.createElement('div');
    groupElement.classList.add('chat-item');
    groupElement.textContent = `Group: ${groupName}`;
    groupElement.dataset.type = 'group';
    groupElement.dataset.id = groupId;
    groupElement.addEventListener('click', () => {
        setCurrentChat({ type: 'group', id: groupId });
    });
    groupChatsList.appendChild(groupElement);
}

// Obtém o nome de exibição de um usuário pelo ID
async function getUserDisplayName(userId) {
    const userRef = doc(db, 'users', userId);
    const userDoc = await getDoc(userRef);
    if (userDoc.exists()) {
        return userDoc.data().displayName || userDoc.data().email;
    } else {
        return 'Unknown User';
    }
}

// Cria um chat em grupo
async function createGroup() {
    const groupName = prompt("Enter a group name:");
    if (!groupName) return;

    // Cria um novo chat em grupo
    const groupChatRef = await addDoc(collection(db, 'groups'), {
        name: groupName,
        userIds: [auth.currentUser.uid],
        createdAt: new Date()
    });
    console.log(`Group chat created: ${groupName}`);

    // Adiciona o novo grupo à sidebar
    addGroupChatToSidebar(groupChatRef.id, groupName);
    // Define o chat atual para o novo grupo
    setCurrentChat({ type: 'group', id: groupChatRef.id });
}

// Rola o chat para o fundo
function scrollToBottom() {
    messagesList.scrollTop = messagesList.scrollHeight;
}

</script>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="/CentralPageFiles/CentralPageFiles.js"></script>
<script src="/OptionsPageFiles/optionPage.js"></script>


</body>
</html>
